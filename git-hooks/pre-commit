#!/bin/bash

# Configuration
GEMFILE_PATH="Gemfile"
FRONTEND_DEPENDENCIES_PATH=("app/views/layouts/_dependencies.erb" "lib/frontend_dependencies.rb")
OUTPUT_PATH="AGENTS.md"

# Function to add a dependency section to the output file
# Usage: add_dependency_section "Title" file1 file2 file3 ...
add_dependency_section() {
  local title="$1"
  shift  # Remove title from arguments, leaving only file paths
  
  {
    echo ""
    echo "## $title"
    echo ""
    echo "\`\`\`"
    for file_path in "$@"; do
      cat "$file_path"
      echo ""
    done
    echo "\`\`\`"
  } >> "$OUTPUT_PATH"
}

# Create the output file with initial instructions
cat > "$OUTPUT_PATH" << 'EOF'
# Files in lib

Files in lib are auto-loaded by Padrino.load!. No explicit require is necessary.

# MongoDB indexes

Please note that MongoDB indexes are created directly in the database, and are not exhaustively defined in model files.

# Tests

Use the following command structure to test a single file:

`foreman run -e .env.test bundle exec ruby -I test test/$1_test.rb`

# Dependencies
EOF

# Add content
add_dependency_section "Gemfile" "$GEMFILE_PATH"
add_dependency_section "Frontend dependencies" "${FRONTEND_DEPENDENCIES_PATH[@]}"

# Stage the updated file so it's included in this commit
git add "$OUTPUT_PATH"
