<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wheel of the Year</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Cinzel:wght@400;600&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0d0a06;
    --bg2: #12100a;
    --gold: #c9a84c;
    --gold-light: #e8c96a;
    --gold-dim: #8a6f2e;
    --cream: #f0e8d5;
    --cream-dim: #c4b89a;
    --ember: #c0522a;
    --frost: #6ab4c8;
    --leaf: #5a8a3c;
    --bloom: #c06080;
    --shadow: rgba(0,0,0,0.8);
  }

  body {
    background: var(--bg);
    color: var(--cream);
    font-family: 'EB Garamond', serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
    position: relative;
  }

  /* Starfield */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      radial-gradient(1px 1px at 10% 15%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 30% 80%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 55% 25%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 75% 70%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 90% 10%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 20% 50%, rgba(255,255,255,0.2) 0%, transparent 100%),
      radial-gradient(1px 1px at 85% 40%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 45% 90%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1.5px 1.5px at 62% 55%, rgba(255,255,220,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 5% 65%, rgba(255,255,255,0.3) 0%, transparent 100%);
    pointer-events: none;
    z-index: 0;
  }

  header {
    text-align: center;
    padding: 3rem 2rem 1.5rem;
    position: relative;
    z-index: 1;
  }

  header h1 {
    font-family: 'Cinzel Decorative', cursive;
    font-size: clamp(1.6rem, 4vw, 2.8rem);
    color: var(--gold-light);
    letter-spacing: 0.08em;
    text-shadow: 0 0 40px rgba(201,168,76,0.5), 0 2px 4px black;
    line-height: 1.2;
  }

  header p {
    margin-top: 0.8rem;
    font-size: 1.05rem;
    color: var(--cream-dim);
    font-style: italic;
    letter-spacing: 0.05em;
  }

  .main-layout {
    display: grid;
    grid-template-columns: 1fr minmax(300px, 460px);
    gap: 2.5rem;
    width: 100%;
    max-width: 1200px;
    padding: 1rem 2rem 4rem;
    position: relative;
    z-index: 1;
    align-items: start;
  }

  @media (max-width: 860px) {
    .main-layout { grid-template-columns: 1fr; }
  }

  /* === WHEEL === */
  .wheel-container {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  #wheel-svg {
    width: 100%;
    max-width: 520px;
    height: auto;
    filter: drop-shadow(0 0 30px rgba(201,168,76,0.12));
    cursor: pointer;
    overflow: visible;
  }

  .segment {
    transition: filter 0.25s, opacity 0.25s;
    cursor: pointer;
  }

  .segment:hover { filter: brightness(1.3); }
  .segment.active { filter: brightness(1.5) drop-shadow(0 0 10px currentColor); }
  .segment.dimmed { opacity: 0.45; }

  .season-label {
    font-family: 'Cinzel', serif;
    font-size: 11px;
    fill: var(--cream-dim);
    text-anchor: middle;
    dominant-baseline: middle;
    pointer-events: none;
    letter-spacing: 0.12em;
  }

  .sabbat-label {
    font-family: 'Cinzel', serif;
    font-size: 9.5px;
    fill: var(--cream);
    text-anchor: middle;
    dominant-baseline: middle;
    pointer-events: none;
    letter-spacing: 0.05em;
  }

  .center-circle text {
    font-family: 'Cinzel Decorative', cursive;
    fill: var(--gold-light);
    text-anchor: middle;
    dominant-baseline: middle;
  }

  /* === INFO PANEL === */
  .info-panel {
    background: linear-gradient(145deg, rgba(20,17,10,0.95), rgba(14,12,8,0.98));
    border: 1px solid var(--gold-dim);
    border-radius: 4px;
    padding: 2rem;
    position: sticky;
    top: 1.5rem;
    min-height: 420px;
    box-shadow: 0 0 60px rgba(0,0,0,0.6), inset 0 1px 0 rgba(201,168,76,0.1);
    transition: border-color 0.4s;
  }

  .info-panel.has-selection {
    border-color: var(--gold);
    box-shadow: 0 0 60px rgba(0,0,0,0.6), 0 0 20px rgba(201,168,76,0.08), inset 0 1px 0 rgba(201,168,76,0.15);
  }

  .panel-prompt {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 380px;
    text-align: center;
    color: var(--cream-dim);
    gap: 1rem;
    opacity: 1;
    transition: opacity 0.3s;
  }

  .panel-prompt.hidden { opacity: 0; pointer-events: none; position: absolute; }

  .panel-prompt .prompt-symbol {
    font-size: 3rem;
    opacity: 0.3;
    animation: breathe 4s ease-in-out infinite;
  }

  @keyframes breathe {
    0%, 100% { opacity: 0.25; transform: scale(1); }
    50% { opacity: 0.45; transform: scale(1.05); }
  }

  .panel-prompt p {
    font-size: 1rem;
    font-style: italic;
    letter-spacing: 0.05em;
    line-height: 1.6;
    max-width: 260px;
  }

  .panel-content {
    display: none;
    flex-direction: column;
    gap: 1rem;
    animation: fadeIn 0.4s ease;
  }

  .panel-content.visible { display: flex; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .panel-header {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(201,168,76,0.2);
  }

  .panel-icon {
    font-size: 2.8rem;
    line-height: 1;
    flex-shrink: 0;
    filter: drop-shadow(0 0 8px currentColor);
  }

  .panel-title-block {}

  .panel-date {
    font-family: 'Cinzel', serif;
    font-size: 0.72rem;
    color: var(--gold);
    letter-spacing: 0.18em;
    text-transform: uppercase;
    margin-bottom: 0.2rem;
  }

  .panel-name {
    font-family: 'Cinzel Decorative', cursive;
    font-size: 1.55rem;
    color: var(--gold-light);
    line-height: 1.15;
    text-shadow: 0 0 20px rgba(201,168,76,0.4);
  }

  .panel-alt {
    font-style: italic;
    font-size: 0.88rem;
    color: var(--cream-dim);
    margin-top: 0.15rem;
  }

  .panel-type-badge {
    display: inline-block;
    font-family: 'Cinzel', serif;
    font-size: 0.62rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    padding: 0.2rem 0.7rem;
    border-radius: 2px;
    margin-top: 0.5rem;
  }

  .badge-cross { background: rgba(201,168,76,0.15); color: var(--gold); border: 1px solid var(--gold-dim); }
  .badge-solar { background: rgba(255,200,80,0.1); color: #f0c040; border: 1px solid rgba(240,192,64,0.4); }

  .panel-body { font-size: 1rem; line-height: 1.75; color: var(--cream); }

  .panel-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.7rem;
    margin-top: 0.5rem;
  }

  .detail-item {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(201,168,76,0.12);
    border-radius: 3px;
    padding: 0.6rem 0.8rem;
  }

  .detail-label {
    font-family: 'Cinzel', serif;
    font-size: 0.6rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--gold-dim);
    margin-bottom: 0.25rem;
  }

  .detail-value { font-size: 0.88rem; color: var(--cream-dim); line-height: 1.4; }

  .traditions-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.8rem;
  }

  .tradition-tag {
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    color: var(--cream-dim);
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 2px;
    padding: 0.2rem 0.6rem;
  }

  /* Legend */
  .legend {
    display: flex;
    justify-content: center;
    gap: 2rem;
    padding: 0.5rem 2rem 2rem;
    position: relative;
    z-index: 1;
    flex-wrap: wrap;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: 'Cinzel', serif;
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    color: var(--cream-dim);
  }

  .legend-dot {
    width: 12px; height: 12px; border-radius: 50%;
    flex-shrink: 0;
  }

  /* Decorative rule */
  .rule {
    width: 100%;
    max-width: 400px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  /* Hemisphere toggle */
  .hemisphere-row {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.4rem;
    position: relative;
    z-index: 1;
    margin: 1rem auto 0;
  }

  .hemisphere-toggle {
    display: flex;
    align-items: stretch;
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--gold-dim);
    border-radius: 3px;
    overflow: hidden;
  }

  .hemi-btn {
    font-family: 'Cinzel', serif;
    font-size: 0.68rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 0.45rem 1.2rem;
    cursor: pointer;
    border: none;
    background: transparent;
    color: var(--cream-dim);
    transition: background 0.2s, color 0.2s;
  }

  .hemi-btn.active {
    background: var(--gold-dim);
    color: #0d0a06;
  }

  .hemi-divider { width: 1px; background: var(--gold-dim); align-self: stretch; }

  .hemi-note {
    font-size: 0.78rem;
    font-style: italic;
    color: var(--cream-dim);
    opacity: 0;
    transition: opacity 0.4s;
    min-height: 1.1em;
  }
  .hemi-note.visible { opacity: 1; }
</style>
</head>
<body>

<header>
  <h1>Wheel of the Year</h1>
  <p>Eight seasonal festivals marking the turning of the year</p>
</header>

<div class="rule"></div>

<div class="hemisphere-row">
  <div class="hemisphere-toggle">
    <button class="hemi-btn active" id="btn-nh" onclick="setHemisphere('north')">&#8679; Northern Hemisphere</button>
    <div class="hemi-divider"></div>
    <button class="hemi-btn" id="btn-sh" onclick="setHemisphere('south')">&#8681; Southern Hemisphere</button>
  </div>
</div>

<div class="main-layout">
  <div class="wheel-container">
    <svg id="wheel-svg" viewBox="-260 -260 520 520" xmlns="http://www.w3.org/2000/svg"></svg>
  </div>

  <div class="info-panel" id="info-panel">
    <div class="panel-prompt" id="panel-prompt">
      <div class="prompt-symbol">‚òΩ ‚ú¶ ‚òæ</div>
      <p>Click any segment of the Wheel to explore the eight festivals of the year</p>
    </div>
    <div class="panel-content" id="panel-content"></div>
  </div>
</div>

<div class="legend">
  <div class="legend-item">
    <div class="legend-dot" style="background:#c9a84c; border: 2px solid #e8c96a;"></div>
    Solar Festival (Solstice / Equinox)
  </div>
  <div class="legend-item">
    <div class="legend-dot" style="background:#5a8a3c; border: 2px solid #7ab45c;"></div>
    Cross-Quarter Day
  </div>
</div>

<script>
const TAU = Math.PI * 2;

// 8 sabbats, starting from Yule (Winter Solstice) at top, going clockwise
// Angles: 0 = top, clockwise. Each sabbat 45¬∞ apart.
// Order clockwise from top: Yule, Imbolc, Ostara, Beltane, Litha, Lughnasadh, Mabon, Samhain
const sabbats = [
  {
    id: 'yule',
    name: 'Yule',
    alt: 'Winter Solstice',
    type: 'solar',
    date: { north: 'December 21', south: 'June 21' },
    angle: 0,
    icon: '‚ùÑÔ∏è',
    color: '#6ab4c8',
    colorDark: '#2a6a88',
    seasonLabel: { north: 'WINTER', south: 'WINTER' },
    desc: 'Yule marks the longest night and the rebirth of the Sun. As the wheel turns and light begins its slow return, ancients lit great bonfires to welcome the returning king of light. The world holds its breath, then exhales into the growing dawn.',
    traditions: ['Holly & Oak Kings', 'Yule Log', 'Evergreens', 'Candle Vigils'],
    themes: 'Rebirth, Light returning, Hope',
    element: 'Earth & Fire',
    direction: 'North',
  },
  {
    id: 'imbolc',
    name: 'Imbolc',
    alt: "Brigid's Day ¬∑ Candlemas",
    type: 'cross',
    date: { north: 'February 1‚Äì2', south: 'August 1‚Äì2' },
    angle: 45,
    icon: 'üïØÔ∏è',
    color: '#c8a0d8',
    colorDark: '#6a3a88',
    seasonLabel: { north: '', south: '' },
    desc: 'Imbolc means "in the belly," honoring the first stirrings of spring within the frozen earth. Sacred to Brigid, goddess of fire, healing, and poetry, this festival celebrates the return of fertility and the quickening of the land under snow.',
    traditions: ['Brigid Crosses', 'Candle Blessing', 'Fire Divination', 'Spring Cleaning'],
    themes: 'Awakening, Purification, New beginnings',
    element: 'Fire & Water',
    direction: 'Northeast',
  },
  {
    id: 'ostara',
    name: 'Ostara',
    alt: 'Spring Equinox',
    type: 'solar',
    date: { north: 'March 20‚Äì21', south: 'September 22‚Äì23' },
    angle: 90,
    icon: 'üå∏',
    color: '#c06080',
    colorDark: '#803050',
    seasonLabel: { north: 'SPRING', south: 'SPRING' },
    desc: 'At Ostara, day and night stand in perfect balance before light triumphs. Named for the Germanic dawn goddess ƒíostre, this is a festival of fertility, seeds, and new life. Hares run wild, eggs are hidden, and the world blooms into color.',
    traditions: ['Egg Decoration', 'Seed Planting', 'Balance Rituals', 'Dawn Vigil'],
    themes: 'Balance, Fertility, New growth',
    element: 'Air',
    direction: 'East',
  },
  {
    id: 'beltane',
    name: 'Beltane',
    alt: 'May Day',
    type: 'cross',
    date: { north: 'May 1', south: 'November 1' },
    angle: 135,
    icon: 'üî•',
    color: '#e07020',
    colorDark: '#904010',
    seasonLabel: { north: '', south: '' },
    desc: 'Beltane blazes with the full fire of spring becoming summer. Fires were lit on every hill; cattle driven between them for protection. Maypoles rose as symbols of sacred union, and the veil between worlds thinned, inviting the fae to walk among us.',
    traditions: ['Beltane Fires', 'Maypole Dance', 'Green Man', 'Handfasting'],
    themes: 'Passion, Union, Fertility at peak',
    element: 'Fire',
    direction: 'Southeast',
  },
  {
    id: 'litha',
    name: 'Litha',
    alt: 'Midsummer ¬∑ Summer Solstice',
    type: 'solar',
    date: { north: 'June 21', south: 'December 21' },
    angle: 180,
    icon: '‚òÄÔ∏è',
    color: '#d4a020',
    colorDark: '#8a6010',
    seasonLabel: { north: 'SUMMER', south: 'SUMMER' },
    desc: 'Litha is the zenith ‚Äî the longest day, when the Sun pauses at the height of its power before beginning its slow descent. Midsummer bonfires burned through the night; faeries were said to roam freely. It is a moment of radiant fullness before the waning begins.',
    traditions: ['Midsummer Bonfires', 'Flower Crowns', 'Well Dressing', 'Sun Wheels'],
    themes: 'Fullness, Power, Celebration before waning',
    element: 'Fire & Air',
    direction: 'South',
  },
  {
    id: 'lughnasadh',
    name: 'Lughnasadh',
    alt: 'Lammas ¬∑ First Harvest',
    type: 'cross',
    date: { north: 'August 1', south: 'February 1' },
    angle: 225,
    icon: 'üåæ',
    color: '#a0b030',
    colorDark: '#507010',
    seasonLabel: { north: '', south: '' },
    desc: 'Lughnasadh, named for the god Lugh, marks the first harvest ‚Äî grain cut, bread baked from new wheat. It is a time of both abundance and bittersweet awareness: the Sun King weakens as the harvest grows. Games, feasting, and sacrifice honored the turning year.',
    traditions: ['Bread Baking', 'Grain Dollies', 'Harvest Games', 'Offerings to Lugh'],
    themes: 'First harvest, Sacrifice, Abundance',
    element: 'Earth & Fire',
    direction: 'Southwest',
  },
  {
    id: 'mabon',
    name: 'Mabon',
    alt: 'Autumn Equinox',
    type: 'solar',
    date: { north: 'September 22‚Äì23', south: 'March 20‚Äì21' },
    angle: 270,
    icon: 'üçÇ',
    color: '#b05820',
    colorDark: '#703010',
    seasonLabel: { north: 'AUTUMN', south: 'AUTUMN' },
    desc: 'Mabon brings the second balance point of the year as darkness begins to gain. The second harvest is gathered; leaves catch flame in amber and crimson. Named for the Welsh divine child, this equinox invites gratitude for what has been reaped and release of what must fall.',
    traditions: ['Apple Harvest', 'Gratitude Altars', 'Ancestor Honoring', 'Wine Making'],
    themes: 'Balance, Gratitude, Preparation for darkness',
    element: 'Water & Air',
    direction: 'West',
  },
  {
    id: 'samhain',
    name: 'Samhain',
    alt: 'All Hallows ¬∑ Ancestor Night',
    type: 'cross',
    date: { north: 'October 31', south: 'April 30' },
    angle: 315,
    icon: 'üåë',
    color: '#7040b0',
    colorDark: '#3a1870',
    seasonLabel: { north: '', south: '' },
    desc: 'Samhain is the great hinge of the year ‚Äî the end and the beginning, when the veil between the living and the dead grows thin as gossamer. The final harvest is brought in, the last fires extinguished and relit from the sacred flame. Ancestors are welcomed home.',
    traditions: ['Dumb Supper', 'Jack-o-Lanterns', 'Ancestor Altars', 'Divination'],
    themes: 'Death, Transition, Ancestral communion',
    element: 'Water',
    direction: 'Northwest',
  },
];

let hemisphere = 'north';

const svg = document.getElementById('wheel-svg');
const infoPanel = document.getElementById('info-panel');
const panelPrompt = document.getElementById('panel-prompt');
const panelContent = document.getElementById('panel-content');

const R_OUTER = 240;
const R_INNER_LABEL = 170;
const R_ICON = 205;
const R_RING = 140;
const R_INNER = 70;

function polarToXY(angleDeg, r) {
  // 0 deg = top, clockwise
  const rad = (angleDeg - 90) * Math.PI / 180;
  return [r * Math.cos(rad), r * Math.sin(rad)];
}

function describeArc(cx, cy, r, startAngle, endAngle) {
  const [x1, y1] = polarToXY(startAngle, r);
  const [x2, y2] = polarToXY(endAngle, r);
  const largeArc = (endAngle - startAngle) > 180 ? 1 : 0;
  return `M ${cx + x1} ${cy + y1} A ${r} ${r} 0 ${largeArc} 1 ${cx + x2} ${cy + y2}`;
}

function createSegment(sabbat, index) {
  const startAngle = sabbat.angle - 22.5;
  const endAngle = sabbat.angle + 22.5;
  
  // Outer segment path
  const [ox1, oy1] = polarToXY(startAngle, R_OUTER);
  const [ox2, oy2] = polarToXY(endAngle, R_OUTER);
  const [ix1, iy1] = polarToXY(startAngle, R_RING);
  const [ix2, iy2] = polarToXY(endAngle, R_RING);
  
  const path = `M ${ox1} ${oy1} A ${R_OUTER} ${R_OUTER} 0 0 1 ${ox2} ${oy2} L ${ix2} ${iy2} A ${R_RING} ${R_RING} 0 0 0 ${ix1} ${iy1} Z`;

  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('class', 'segment');
  g.dataset.id = sabbat.id;
  g.dataset.index = index;

  // Segment fill
  const p = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  p.setAttribute('d', path);
  p.setAttribute('fill', sabbat.colorDark);
  p.setAttribute('stroke', '#0d0a06');
  p.setAttribute('stroke-width', '1.5');
  g.appendChild(p);

  // Gradient overlay
  const gradId = `grad-${sabbat.id}`;
  const defs = svg.querySelector('defs') || (() => { const d = document.createElementNS('http://www.w3.org/2000/svg', 'defs'); svg.appendChild(d); return d; })();
  const grad = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
  grad.setAttribute('id', gradId);
  grad.setAttribute('cx', '50%'); grad.setAttribute('cy', '50%');
  grad.setAttribute('r', '50%');
  const s1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
  s1.setAttribute('offset', '0%');
  s1.setAttribute('stop-color', sabbat.color);
  s1.setAttribute('stop-opacity', '0.3');
  const s2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
  s2.setAttribute('offset', '100%');
  s2.setAttribute('stop-color', sabbat.color);
  s2.setAttribute('stop-opacity', '0');
  grad.appendChild(s1); grad.appendChild(s2);
  defs.appendChild(grad);

  const p2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  p2.setAttribute('d', path);
  p2.setAttribute('fill', `url(#${gradId})`);
  p2.setAttribute('stroke', 'none');
  g.appendChild(p2);

  // Rim arc highlight
  const rimPath = describeArc(0, 0, R_OUTER - 1, startAngle + 0.5, endAngle - 0.5);
  const rim = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  rim.setAttribute('d', rimPath);
  rim.setAttribute('fill', 'none');
  rim.setAttribute('stroke', sabbat.color);
  rim.setAttribute('stroke-width', '2.5');
  rim.setAttribute('opacity', '0.6');
  g.appendChild(rim);

  // Type indicator (solar = diamond dot, cross = circle dot) at mid-outer edge
  const midAngle = sabbat.angle;
  const [mx, my] = polarToXY(midAngle, R_OUTER - 12);
  const indicator = document.createElementNS('http://www.w3.org/2000/svg', sabbat.type === 'solar' ? 'rect' : 'circle');
  if (sabbat.type === 'solar') {
    indicator.setAttribute('x', mx - 5);
    indicator.setAttribute('y', my - 5);
    indicator.setAttribute('width', '10');
    indicator.setAttribute('height', '10');
    indicator.setAttribute('transform', `rotate(45, ${mx}, ${my})`);
    indicator.setAttribute('fill', sabbat.color);
    indicator.setAttribute('opacity', '0.9');
  } else {
    indicator.setAttribute('cx', mx);
    indicator.setAttribute('cy', my);
    indicator.setAttribute('r', '5');
    indicator.setAttribute('fill', sabbat.color);
    indicator.setAttribute('opacity', '0.9');
  }
  g.appendChild(indicator);

  // Sabbat name label - rotated along spoke
  const labelR = (R_RING + R_OUTER) / 2 - 12;
  const [lx, ly] = polarToXY(midAngle, labelR);
  const labelAngle = midAngle; // rotation for text

  const textG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  textG.setAttribute('transform', `translate(${lx}, ${ly}) rotate(${midAngle})`);

  const nameText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  nameText.setAttribute('class', 'sabbat-label');
  nameText.setAttribute('x', '0');
  nameText.setAttribute('y', '0');
  nameText.textContent = sabbat.name.toUpperCase();
  textG.appendChild(nameText);
  g.appendChild(textG);

  g.addEventListener('click', () => selectSabbat(index));
  return g;
}

function buildWheel() {
  // Defs
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  svg.appendChild(defs);

  // Background circle
  const bg = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  bg.setAttribute('cx', '0'); bg.setAttribute('cy', '0'); bg.setAttribute('r', R_OUTER.toString());
  bg.setAttribute('fill', '#0a0806');
  bg.setAttribute('stroke', 'rgba(201,168,76,0.2)');
  bg.setAttribute('stroke-width', '1');
  svg.appendChild(bg);

  // Concentric decorative rings
  [R_RING, R_INNER + 30, R_INNER].forEach((r, i) => {
    const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    c.setAttribute('cx', '0'); c.setAttribute('cy', '0'); c.setAttribute('r', r.toString());
    c.setAttribute('fill', 'none');
    c.setAttribute('stroke', `rgba(201,168,76,${i === 0 ? 0.35 : 0.2})`);
    c.setAttribute('stroke-width', i === 0 ? '1.5' : '0.8');
    svg.appendChild(c);
  });

  // Spoke lines (dividers)
  for (let i = 0; i < 8; i++) {
    const angle = i * 45 - 22.5;
    const [x1, y1] = polarToXY(angle, R_INNER);
    const [x2, y2] = polarToXY(angle, R_OUTER);
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', x1); line.setAttribute('y1', y1);
    line.setAttribute('x2', x2); line.setAttribute('y2', y2);
    line.setAttribute('stroke', 'rgba(201,168,76,0.25)');
    line.setAttribute('stroke-width', '0.8');
    svg.appendChild(line);
  }

  // Segments
  sabbats.forEach((s, i) => {
    const g = createSegment(s, i);
    svg.appendChild(g);
  });

  // Season labels (in inner ring) ‚Äî stored for hemisphere swapping
  // NH: Winter=top(0¬∞), Spring=right(90¬∞), Summer=bottom(180¬∞), Autumn=left(270¬∞)
  // SH: same wheel positions but seasons are flipped
  const seasonPositions = [
    { angle: 0,   nh: 'WINTER', sh: 'WINTER' },
    { angle: 90,  nh: 'SPRING', sh: 'SPRING' },
    { angle: 180, nh: 'SUMMER', sh: 'SUMMER' },
    { angle: 270, nh: 'AUTUMN', sh: 'AUTUMN' },
  ];
  seasonPositions.forEach(({ angle, nh, sh }, i) => {
    // Spring (90¬∞) and Autumn (270¬∞) pulled inward to avoid overlapping segments
    const r = (angle === 90 || angle === 270) ? R_INNER + 32 : R_INNER + 50;
    const [sx, sy] = polarToXY(angle, r);
    const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    t.setAttribute('class', 'season-label');
    t.setAttribute('id', 'season-label-' + i);
    const xOffset = (angle === 270) ? -4 : (angle === 90) ? 2 : 0;
    t.setAttribute('x', sx + xOffset); t.setAttribute('y', sy);
    t.textContent = nh;
    t.dataset.nh = nh;
    t.dataset.sh = sh;
    svg.appendChild(t);
  });

  // Equinox/Solstice direction ticks (short lines at 0,90,180,270 in center ring)
  [0, 180].forEach(angle => {
    const [x1, y1] = polarToXY(angle, R_INNER + 30);
    const [x2, y2] = polarToXY(angle, R_INNER + 38);
    const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    tick.setAttribute('x1', x1); tick.setAttribute('y1', y1);
    tick.setAttribute('x2', x2); tick.setAttribute('y2', y2);
    tick.setAttribute('stroke', 'rgba(201,168,76,0.5)'); tick.setAttribute('stroke-width', '1.5');
    svg.appendChild(tick);
  });

  // Center inner circle fill
  const centerFill = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  centerFill.setAttribute('cx', '0'); centerFill.setAttribute('cy', '0'); centerFill.setAttribute('r', R_INNER.toString());
  centerFill.setAttribute('fill', '#0d0a06');
  centerFill.setAttribute('stroke', 'rgba(201,168,76,0.5)');
  centerFill.setAttribute('stroke-width', '1');
  svg.appendChild(centerFill);

  // Moon phase in center
  const moon = getMoonPhase();

  const moonGlyph = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  moonGlyph.setAttribute('x', '0'); moonGlyph.setAttribute('y', '4');
  moonGlyph.setAttribute('text-anchor', 'middle');
  moonGlyph.setAttribute('dominant-baseline', 'middle');
  moonGlyph.setAttribute('font-family', 'serif');
  moonGlyph.setAttribute('font-size', '26');
  moonGlyph.setAttribute('fill', '#c4b89a');
  moonGlyph.textContent = moon.emoji;
  svg.appendChild(moonGlyph);

  const moonLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  moonLabel.setAttribute('x', '0'); moonLabel.setAttribute('y', '28');
  moonLabel.setAttribute('text-anchor', 'middle');
  moonLabel.setAttribute('font-family', 'Cinzel, serif');
  moonLabel.setAttribute('font-size', '7');
  moonLabel.setAttribute('fill', '#c4b89a');
  moonLabel.setAttribute('letter-spacing', '1');
  moonLabel.textContent = moon.name.toUpperCase();
  svg.appendChild(moonLabel);
}

let activeIndex = null;

function selectSabbat(index) {
  if (activeIndex === index) {
    activeIndex = null;
    document.querySelectorAll('.segment').forEach(g => g.classList.remove('active', 'dimmed'));
    infoPanel.classList.remove('has-selection');
    panelPrompt.classList.remove('hidden');
    panelContent.classList.remove('visible');
    return;
  }
  activeIndex = index;

  // Update segment classes
  document.querySelectorAll('.segment').forEach((g, i) => {
    g.classList.remove('active', 'dimmed');
    if (i === index) g.classList.add('active');
    else g.classList.add('dimmed');
  });

  const s = sabbats[index];
  const dateStr = typeof s.date === 'object' ? s.date[hemisphere] : s.date;
  infoPanel.classList.add('has-selection');
  panelPrompt.classList.add('hidden');

  panelContent.innerHTML = `
    <div class="panel-header">
      <div class="panel-icon" style="color:${s.color}">${s.icon}</div>
      <div class="panel-title-block">
        <div class="panel-date">${dateStr}</div>
        <div class="panel-name">${s.name}</div>
        <div class="panel-alt">${s.alt}</div>
        <span class="panel-type-badge ${s.type === 'solar' ? 'badge-solar' : 'badge-cross'}">${s.type === 'solar' ? '‚óà Solar Festival' : '‚óè Cross-Quarter Day'}</span>
      </div>
    </div>
    <div class="panel-body">${s.desc}</div>
    <div class="detail-item">
      <div class="detail-label">Themes</div>
      <div class="detail-value">${s.themes}</div>
    </div>
  `;

  panelContent.classList.add('visible');
}

function setHemisphere(hemi) {
  if (hemisphere === hemi) return;
  hemisphere = hemi;

  // Toggle buttons
  document.getElementById('btn-nh').classList.toggle('active', hemi === 'north');
  document.getElementById('btn-sh').classList.toggle('active', hemi === 'south');

  // Show/hide note
  // Update season labels on the wheel
  document.querySelectorAll('[id^="season-label-"]').forEach(el => {
    el.textContent = el.dataset[hemi === 'north' ? 'nh' : 'sh'];
  });

  // Refresh panel if a sabbat is selected
  if (activeIndex !== null) {
    const prev = activeIndex;
    activeIndex = null;
    selectSabbat(prev);
  }
}

function getMoonPhase() {
  // Synodic month = 29.53059 days. Known new moon: Jan 6, 2000 18:14 UTC
  const known = new Date(Date.UTC(2000, 0, 6, 18, 14));
  const now = new Date();
  const elapsed = (now - known) / (1000 * 60 * 60 * 24);
  const cycle = 29.53059;
  const phase = ((elapsed % cycle) + cycle) % cycle; // 0‚Äì29.53

  const phases = [
    { max: 1.85,  name: 'New Moon',        emoji: 'üåë' },
    { max: 7.38,  name: 'Waxing Crescent', emoji: 'üåí' },
    { max: 9.22,  name: 'First Quarter',   emoji: 'üåì' },
    { max: 14.77, name: 'Waxing Gibbous',  emoji: 'üåî' },
    { max: 16.61, name: 'Full Moon',        emoji: 'üåï' },
    { max: 22.15, name: 'Waning Gibbous',  emoji: 'üåñ' },
    { max: 23.99, name: 'Last Quarter',    emoji: 'üåó' },
    { max: 29.53, name: 'Waning Crescent', emoji: 'üåò' },
  ];

  return phases.find(p => phase < p.max) || phases[0];
}

buildWheel();
</script>
</body>
</html>
