<%
  node_min_width = 0
  edge_min_opacity = 0.25
  edge_opacity_scale = 10
  color = '#00B963'

  models = Dir.entries("#{PADRINO_ROOT}/models")
    .select { |filename| filename.ends_with?('.rb') }
    .map { |filename| filename.split('.rb').first.camelize.constantize }

  elements = []

  models.each do |model|
    w = model.fields.count + model.reflect_on_all_associations(:belongs_to).count
    elements << {
      data: {
        id: model.name.underscore,
        name: model.name,
        weight: w,
        width: node_min_width + w,
        color: color
      }
    }

    model.reflect_on_all_associations(:has_many).each_with_index do |assoc, i|
      elements << {
        data: {
          id: "#{assoc.class_name.underscore}-#{model.name.underscore}-#{i}",
          source: assoc.class_name.underscore,
          target: model.name.underscore,
          weight: 1,
          color: color,
          opacity: edge_min_opacity + 1.0 / edge_opacity_scale
        }
      }
    end
  end
%>

<%= partial :network_script, locals: {
  node_min_width: node_min_width,
  node_min_color: 0,
  node_color_scale: 1,
  edge_min_color: 0,
  edge_color_scale: 1,
  edge_min_opacity: edge_min_opacity,
  edge_opacity_scale: edge_opacity_scale,
  elements: elements.to_json,
  tap_handler: "window.open('https://github.com/symbiota-coop/dandelion/blob/master/models/' + this.data('id') + '.rb')"
} %>
