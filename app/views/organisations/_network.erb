<%
  node_min_width = 10
  node_width_scale = 20
  edge_min_opacity = 0.25
  edge_opacity_scale = 100
  color = '#00B963'

  organisation_edges = OrganisationEdge.and(:mutual_followers.gte => Padrino.env == :development ? 1 : 10)
  organisations = Organisation.and(:id.in => organisation_edges.pluck(:source_id) + organisation_edges.pluck(:sink_id))

  elements = []

  organisations.each do |organisation|
    w = organisation.followers_count
    elements << {
      data: {
        id: organisation.id.to_s,
        slug: organisation.slug,
        name: CGI.unescapeHTML(Sanitize.fragment(organisation.name)),
        weight: w,
        width: node_min_width + w.to_f / node_width_scale,
        color: color
      }
    }

    organisation_edges.and(source: organisation).each do |edge|
      w = edge.mutual_followers
      elements << {
        data: {
          id: edge.id.to_s,
          source: edge.source.id.to_s,
          target: edge.sink.id.to_s,
          weight: w,
          color: color,
          opacity: edge_min_opacity + w.to_f / edge_opacity_scale
        }
      }
    end
  end
%>

<%= partial :network_script, locals: {
  elements: elements.to_json,
  tap_handler: "window.open('/o/' + this.data('slug'), '_blank');"
} %>