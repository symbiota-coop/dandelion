<%= partial :'event_feedbacks/average_rating', locals: { event_feedbacks: event_feedbacks } %>

<% if !params[:minimal] %>

  <% if @activity %>
    <% if @activity.feedback_summary %>
      <div class="ai-well my-3 readable" data-toggle="tooltip" title="AI-generated summary ✨">
        <%= @activity.feedback_summary %>
      </div>
    <% end %>
    <% if activity_admin? %>
      <div class="mt-1">
        <% if admin? || (@activity.feedback_summary_last_refreshed_at.nil? || @activity.feedback_summary_last_refreshed_at <= 24.hours.ago) %>
          <% if @activity.feedback_summary_last_refreshed_at.nil? %>
            <a href="/activities/<%= @activity.id %>/feedback_summary">Refresh feedback summary</a>
          <% else %>
            <span class="text-muted">Last updated <%= timeago @activity.feedback_summary_last_refreshed_at %> ·</span> <a href="/activities/<%= @activity.id %>/feedback_summary">Refresh</a>
          <% end %>
        <% else %>
          <span class="text-muted">Refresh again in <%= distance_of_time_in_words(Time.now, @activity.feedback_summary_last_refreshed_at + 24.hours) %></span>
        <% end %>
        <% if @activity.feedback_summary %>
          <span class="text-muted"> · </span><a href="/activities/<%= @activity.id %>/feedback_summary/delete" data-confirm="Are you sure you want to remove this feedback summary?">Remove</a>
        <% end %>
      </div>
    <% end %>
  <% elsif @account %>
    <% if @account.feedback_summary %>
      <div class="ai-well my-3 readable" data-toggle="tooltip" title="AI-generated summary ✨">
        <%= @account.feedback_summary %>
      </div>
    <% end %>
    <% if (admin? || (current_account && @account == current_account)) %>
      <div class="mt-1">
        <% if admin? || (@account.feedback_summary_last_refreshed_at.nil? || @account.feedback_summary_last_refreshed_at <= 24.hours.ago) %>
          <% if @account.feedback_summary_last_refreshed_at.nil? %>
            <a href="/accounts/<%= @account.id %>/feedback_summary">Refresh feedback summary</a>
          <% else %>
            <span class="text-muted">Last updated <%= timeago @account.feedback_summary_last_refreshed_at %> ·</span> <a href="/accounts/<%= @account.id %>/feedback_summary">Refresh</a>
          <% end %>
        <% else %>
          <span class="text-muted">Refresh again in <%= distance_of_time_in_words(Time.now, @account.feedback_summary_last_refreshed_at + 24.hours) %></span>
        <% end %>
        <% if @account.feedback_summary %>
          <span class="text-muted"> · </span><a href="/accounts/<%= @account.id %>/feedback_summary/delete" data-confirm="Are you sure you want to remove this feedback summary?">Remove</a>
        <% end %>
      </div>
    <% end %>
  <% elsif @organisation %>
    <% if @organisation.feedback_summary %>
      <div class="ai-well my-3 readable" data-toggle="tooltip" title="AI-generated summary ✨">
        <%= @organisation.feedback_summary %>
      </div>
    <% end %>
    <% if organisation_admin? %>
      <div class="mt-1">
        <% if admin? || (@organisation.feedback_summary_last_refreshed_at.nil? || @organisation.feedback_summary_last_refreshed_at <= 24.hours.ago) %>
          <% if @organisation.feedback_summary_last_refreshed_at.nil? %>
            <a href="/organisations/<%= @organisation.id %>/feedback_summary">Refresh feedback summary</a>
          <% else %>
            <span class="text-muted">Last updated <%= timeago @organisation.feedback_summary_last_refreshed_at %> ·</span> <a href="/organisations/<%= @organisation.id %>/feedback_summary">Refresh</a>
          <% end %>
        <% else %>
          <span class="text-muted">Refresh again in <%= distance_of_time_in_words(Time.now, @organisation.feedback_summary_last_refreshed_at + 24.hours) %></span>
        <% end %>
        <% if @organisation.feedback_summary %>
          <span class="text-muted"> · </span><a href="/organisations/<%= @organisation.id %>/feedback_summary/delete" data-confirm="Are you sure you want to remove this feedback summary?">Remove</a>
        <% end %>
      </div>
    <% end %>
  <% end %>

<% end %>

<% event_feedbacks = event_feedbacks.and(:rating.ne => nil).order('created_at desc').paginate(page: params[:page], per_page: 10) %>
<table class="table table-borderless mt-3">
  <% event_feedbacks.each { |event_feedback| account = event_feedback.account %>
  <tr <% if event_feedback.deleted_at%>style="opacity: 0.5"<% end %>>
    <td class="feedback-name">
      <% if !account || event_feedback.anonymous? %>
        Anonymous
      <% else %>
        <% if account.publicly_visible? %>
          <% if account.image && !params[:hide_pictures] %>
            <%= partial :'accounts/square', locals: { account: account, width: '50px' } %>
            <br class="d-lg-none" />
          <% end %>
          <a <% if params[:minimal] %>target="_blank"<% end %> href="/u/<%= account.username %>"><%= account.name %></a>
        <% else %>
          <%= account.abbrname %>
        <% end %>
      <% end %>
      <% if event_feedback.event %>
        on <a <% if params[:minimal] %>target="_blank"<% end %>  href="/e/<%= event_feedback.event.slug %>"><%= event_feedback.event.name %></a>
      <% end %>
    </td>
    <td style="white-space: nowrap;"><% if event_feedback.deleted_at%><em>Removed</em><% else %><% event_feedback.rating.times do %><i class="bi bi-star-fill"></i><% end %><% end %></td>
    <td><small><%= timeago event_feedback.created_at %></small></td>
  </tr>
  <% if !event_feedback.deleted_at && (event_feedback.public_answers || event_feedback.response) %>
    <tr>
      <td colspan="3" style="border-top: 0">
        <%= partial :'event_feedbacks/event_feedback', locals: { event_feedback: event_feedback } %>
      </td>
    </tr>
  <% end %>
  <% } %>
</table>
<%= will_paginate event_feedbacks, page_links: false, renderer: WillPaginate::ViewHelpers::BootstrapRenderer %>
