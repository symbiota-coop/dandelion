<%
recommended_events = @account.recommended_events || []
show_image = (Padrino.env == :production)
events_by_id = Event.and(:id.in => recommended_events.map(&:first)).includes(:event_facilitations, :cohostships).index_by { |e| e.id.to_s }
%>

<%= partial :'recommendations/nav' %>
<% r = 0 %>

<% if recommended_events.empty? %>
  <em>No recommended events</em>
<% else %>
  <div class="mb-3">
    <div class="row" id="events">
      <% recommended_events.each { |event_id, people| event = events_by_id[event_id.to_s]; next unless event;
        next if event.locked? && !event_admin?(event)
        next if event.sold_out?
        next if event.created_at < 1.year.ago
        next if event.event_facilitations.find_by(account: current_account);
        r = r + 1;
        %>
      <div class="col-12 <%= block_class if defined?(block_class) %>" id="<%= event.id %>">
        <div class="mb-4">

          <div class="row block no-gutters align-items-stretch <% if event.locked? %>event-locked<% end %>">
            <% if show_image && event.image %>
              <div class="col-lg-6 order-lg-2 mb-2 mb-lg-0 bg-white">
                <% if @organisation && (cohostship = event.cohostships.find_by(organisation: @organisation)) && cohostship.image %>
                  <a target="_parent" href="/e/<%= event.slug %>?cohost=<%=@organisation.slug%>"><%= blurred_image_tag(cohostship.image, width: cohostship.image_width_unmagic, height: cohostship.image_height_unmagic) %></a>
                <% elsif event.image %>
                  <a target="_parent" href="/e/<%= event.slug %>"><%= blurred_image_tag(event.image, width: event.image_width_unmagic, height: event.image_height_unmagic) %></a>
                <% end %>
              </div>
            <% end %>
            <div class="<% if show_image && !event.image %>col-lg-12<% else %>col-lg-6<% end %> order-lg-1">
              <table style="width: 100%; height: 100%">
                <tr>
                  <td style="vertical-align: top">
                    <div class="row justify-content-between">
                      <div class="col ml-1 p-lg-3">
                        <%= partial :'events/block_main', locals: { event: event, skip_final_ul: true } %>

                        <% people_accounts = Account.and(:id.in => people.map(&:first)) %>
                        <% private_account_ids = people_accounts.select(&:private?).map { |a| a.id.to_s } %>
                        <% private_count = private_account_ids.count %>
                        <% private_events_count = people.select { |k, _v| private_account_ids.include?(k.to_s) }.sum { |_k, v| v.count } %>
                        <% public_count = people_accounts.count - private_count %>
                        <li><i data-toggle="tooltip" title="People" class="bi bi-person-fill"></i>
                          <% people.each { |k,v| account = people_accounts.find { |a| a.id.to_s == k.to_s }; next unless account;
                          next if account.private?
                          %>
                          <a href="/u/<%=account.username%>"><%=account.name%></a>,
                          <span data-toggle="tooltip">
                            <%=pluralize v.count, 'event'%> in common
                          </span>
                          <span class="d-none">
                            <%
                              # Collect IDs by type
                              event_ids = v.select { |connection| connection['type'] == 'Event' }.map { |connection| connection['id'] }
                              gathering_ids = v.select { |connection| connection['type'] == 'Gathering' }.map { |connection| connection['id'] }
                              
                              # Bulk query events and gatherings
                              events = event_ids.any? ? Event.and(:id.in => event_ids).order('start_time desc') : []
                              gatherings = gathering_ids.any? ? Gathering.and(:id.in => gathering_ids) : []
                            %>
                            <% events.each { |event| %>
                            <%= event.name %><br />
                            <% } %>
                            <% gatherings.each { |gathering| %>
                            <%= gathering.name %><br />
                            <% } %>
                          </span>
                          <br />
                          <% } %>
                          <% if private_count > 0 %>
                            <% if public_count > 0 %>
                              and <%= pluralize(private_count, 'other person', 'other people') %> with <%= pluralize(private_events_count, 'event') %> in common
                            <% else %>
                              <%= pluralize(private_count, 'person', 'people') %> with <%= pluralize(private_events_count, 'event') %> in common
                            <% end %>
                          <% end %>
                        </li>
                      </ul>

                    </div>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>

      </div>
    </div>
    <% break if r == 20 %>
    <% } %>
  </div>
</div>
<% end %>
